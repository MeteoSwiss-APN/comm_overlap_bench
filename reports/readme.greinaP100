#!/bin/sh
# greina28:
## cuda/8.0.61 + mvapich/2.2 + gcc/4.9.3

### Setup:
module load slurm 
salloc -p long -w greina28
ssh greina28  # <---------------
module purge
module load gmvapich2/17.01_cuda_8.0.61

Currently Loaded Modulefiles:
GCC/4.9.3-binutils-2.25
cuda80/8.0.61
slurm/15.08.6
MVAPICH2/2.2-GCC-4.9.3-binutils-2.25
gmvapich2/17.01_cuda_8.0.61

### Compile: with CUDASETDEVICE
cd src/
make -f makefile-greina28 clean
make -f makefile-greina28

../mpicxx.scorep -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE  -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11  -c main.cpp # -o main.o
+ '[' off = on ']'
++ which mpicxx
+ /cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/bin/mpicxx -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11 -c main.cpp
+ set +x

../mpicxx.scorep -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE  -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11  -c Repository.cpp # -o Repository.o
+ '[' off = on ']'
++ which mpicxx
+ /cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/bin/mpicxx -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11 -c Repository.cpp
+ set +x

../mpicxx.scorep -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE  -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11  -c Options.cpp # -o Options.o
+ '[' off = on ']'
++ which mpicxx
+ /cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/bin/mpicxx -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11 -c Options.cpp
+ set +x

../mpicxx.scorep -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE  -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11  -c MPIHelper.cpp # -o MPIHelper.o
+ '[' off = on ']'
++ which mpicxx
+ /cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/bin/mpicxx -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11 -c MPIHelper.cpp
+ set +x

../nvcc.scorep -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -ccbin g++ -m64 -arch=sm_60 -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE  -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11  -D__CUDACC__ -Xcompiler ,\"-g\",\"-std=c++11\" -c Kernel.cu # -o Kernel.o
+ '[' off = on ']'
++ which nvcc
+ /cm/shared/apps/cuda8/bin/nvcc -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -ccbin g++ -m64 -arch=sm_60 -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11 -D__CUDACC__ -Xcompiler ',"-g","-std=c++11"' -c Kernel.cu
cc1: warning: command line option '-std=c++11' is valid for C++/ObjC++ but not for C
cc1: warning: command line option '-std=c++11' is valid for C++/ObjC++ but not for C
+ set +x

../nvcc.scorep -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -ccbin g++ -m64 -arch=sm_60 -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE  -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11  -D__CUDACC__ -Xcompiler ,\"-g\",\"-std=c++11\" -c HorizontalDiffusionSA.cu # -o HorizontalDiffusionSA.o
+ '[' off = on ']'
++ which nvcc
+ /cm/shared/apps/cuda8/bin/nvcc -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -ccbin g++ -m64 -arch=sm_60 -I/cm/shared/apps/cuda8//include -I/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/include -I. -DENABLE_MPI_TIMER -DCUDASETDEVICE -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11 -D__CUDACC__ -Xcompiler ',"-g","-std=c++11"' -c HorizontalDiffusionSA.cu
cc1: warning: command line option '-std=c++11' is valid for C++/ObjC++ but not for C
cc1: warning: command line option '-std=c++11' is valid for C++/ObjC++ but not for C
+ set +x

../mpicxx.scorep -g -std=gnu++11 -Wl,--enable-new-dtags -L/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/lib64 -L/cm/shared/apps/cuda8//lib64 -lmpi -lmpicxx -lcudart -lcuda  main.o Repository.o Options.o MPIHelper.o Kernel.o HorizontalDiffusionSA.o -o GNU4.9.3_MVAPICH22.2_CUDAV8.0.61.greina28
+ '[' off = on ']'
++ which mpicxx
+ /cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/bin/mpicxx -g -std=gnu++11 -Wl,--enable-new-dtags -L/cm/shared/apps/easybuild/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25/lib64 -L/cm/shared/apps/cuda8//lib64 -lmpi -lmpicxx -lcudart -lcuda main.o Repository.o Options.o MPIHelper.o Kernel.o HorizontalDiffusionSA.o -o GNU4.9.3_MVAPICH22.2_CUDAV8.0.61.greina28
+ set +x


### Run:
piccinal@greina28:~$ 
 exit
 logout
Connection to greina28 closed.
piccinal@greina0:~/comm_overlap_bench.gitjg/GREINA28$barebones 
 exit
 exit
 salloc: Relinquishing job allocation 31040
 salloc: Job allocation 31040 has been revoked.

### Run: exe compiled with -DCUDASETDEVICE
module load gmvapich2/17.01_cuda_8.0.61
export MV2_USE_CUDA=1

srun -p long --cpu_bind=cores --hint=nomultithread --mpi=pmi2 \
-n2 --ntasks-per-node=2 --gres=gpu:2 -w greina28 -t1 \
./GNU4.9.3_MVAPICH22.2_CUDAV8.0.61.greina28 

CUDA_VISIBLE_DEVICES: [0: 0,1] [1: 0,1] 
Configured CUDA Devices: [0: 0] [1: 1] 
SLURM_JOBID: 31039
SLURM_PROCID: 0, 1, 
SLURM_CPU_BIND: [0: quiet,mask_cpu:0x0000000001,0x0000000400] 
                [1: quiet,mask_cpu:0x0000000001,0x0000000400] 
SLURMD_NODENAME: greina28, greina28, 
MV2_USE_CUDA: 1
ELAPSED TIME (seconds) for rank=0 3.649331
ELAPSED TIME (seconds) for rank=1 3.649977


### Run: exe compiled without -DCUDASETDEVICE
module load gmvapich2/17.01_cuda_8.0.61
export MV2_USE_CUDA=1

srun -p long --cpu_bind=cores --hint=nomultithread --mpi=pmi2 \
-n2 --ntasks-per-node=2 --gres=gpu:2 -w greina28 -t1 \
./GNU4.9.3_MVAPICH22.2_CUDAV8.0.61.greina28-setdevice

CUDA_VISIBLE_DEVICES: [0: 0,1] [1: 0,1] 
Configured CUDA Devices: [0: 0] [1: 0] 
SLURM_JOBID: 31154
SLURM_PROCID: 0, 1, 
SLURM_CPU_BIND: [0: quiet,mask_cpu:0x0000000001,0x0000000400] 
                [1: quiet,mask_cpu:0x0000000001,0x0000000400] 
SLURMD_NODENAME: greina28, greina28, 
MV2_USE_CUDA: 1
ELAPSED TIME (seconds) for rank=0 9.827496
ELAPSED TIME (seconds) for rank=1 9.827412
 


# srun -p long --cpu_bind=cores --hint=nomultithread --mpi=pmi2 -n1 \
# --ntasks-per-node=1 --gres=gpu:1 -w greina28 -t1 nvidia-smi topo -m   

        GPU0    GPU1  mlx5_0    CPU Affinity
GPU0      X      NV2  PHB       0-9,20-29
GPU1    NV2        X  SOC       10-19,30-39
mlx5_0  PHB      SOC  X  

Legend:

  X   = Self
  SOC  = Connection traversing PCIe as well as the SMP link between CPU sockets(e.g. QPI)
  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)
  PXB  = Connection traversing multiple PCIe switches (without traversing the PCIe Host Bridge)
  PIX  = Connection traversing a single PCIe switch
  NV#  = Connection traversing a bonded set of # NVLinks


# srun -p long --cpu_bind=cores --hint=nomultithread --mpi=pmi2 -n1 \
# --ntasks-per-node=1 --gres=gpu:1 -w greina28 -t1 nvidia-smi -q

==============NVSMI LOG==============

Timestamp                           : Mon Apr  3 10:48:07 2017
Driver Version                      : 367.48

Attached GPUs                       : 2
GPU 0000:07:00.0
    Product Name                    : Tesla P100-SXM2-16GB
    Product Brand                   : Tesla
    Display Mode                    : Disabled
    Display Active                  : Disabled
    Persistence Mode                : Enabled
    Accounting Mode                 : Disabled
    Accounting Mode Buffer Size     : 1920
    Driver Model
        Current                     : N/A
        Pending                     : N/A
    Serial Number                   : 0322816174234
    GPU UUID                        : GPU-82bca901-c8d2-cff9-fb94-a6054e6e9a53
    Minor Number                    : 0
    VBIOS Version                   : 86.00.1C.00.01
    MultiGPU Board                  : No
    Board ID                        : 0x700
    GPU Part Number                 : 900-2H403-0000-000
    Inforom Version
        Image Version               : H403.0201.00.04
        OEM Object                  : 1.1
        ECC Object                  : 4.1
        Power Management Object     : N/A
    GPU Operation Mode
        Current                     : N/A
        Pending                     : N/A
    GPU Virtualization Mode
        Virtualization mode         : None
    PCI
        Bus                         : 0x07
        Device                      : 0x00
        Domain                      : 0x0000
        Device Id                   : 0x15F910DE
        Bus Id                      : 0000:07:00.0
        Sub System Id               : 0x116B10DE
        GPU Link Info
            PCIe Generation
                Max                 : 3
                Current             : 3
            Link Width
                Max                 : 16x
                Current             : 16x
        Bridge Chip
            Type                    : N/A
            Firmware                : N/A
        Replays since reset         : 0
        Tx Throughput               : 0 KB/s
        Rx Throughput               : 0 KB/s
    Fan Speed                       : N/A
    Performance State               : P0
    Clocks Throttle Reasons
        Idle                        : Active
        Applications Clocks Setting : Not Active
        SW Power Cap                : Not Active
        HW Slowdown                 : Not Active
        Sync Boost                  : Not Active
        Unknown                     : Not Active
    FB Memory Usage
        Total                       : 16276 MiB
        Used                        : 0 MiB
        Free                        : 16276 MiB
    BAR1 Memory Usage
        Total                       : 16384 MiB
        Used                        : 2 MiB
        Free                        : 16382 MiB
    Compute Mode                    : Default
    Utilization
        Gpu                         : 0 %
        Memory                      : 0 %
        Encoder                     : 0 %
        Decoder                     : 0 %
    Ecc Mode
        Current                     : Disabled
        Pending                     : Disabled
    ECC Errors
        Volatile
            Single Bit            
                Device Memory       : N/A
                Register File       : N/A
                L1 Cache            : N/A
                L2 Cache            : N/A
                Texture Memory      : N/A
                Texture Shared      : N/A
                Total               : N/A
            Double Bit            
                Device Memory       : N/A
                Register File       : N/A
                L1 Cache            : N/A
                L2 Cache            : N/A
                Texture Memory      : N/A
                Texture Shared      : N/A
                Total               : N/A
        Aggregate
            Single Bit            
                Device Memory       : N/A
                Register File       : N/A
                L1 Cache            : N/A
                L2 Cache            : N/A
                Texture Memory      : N/A
                Texture Shared      : N/A
                Total               : N/A
            Double Bit            
                Device Memory       : N/A
                Register File       : N/A
                L1 Cache            : N/A
                L2 Cache            : N/A
                Texture Memory      : N/A
                Texture Shared      : N/A
                Total               : N/A
    Retired Pages
        Single Bit ECC              : 0
        Double Bit ECC              : 0
        Pending                     : No
    Temperature
        GPU Current Temp            : 30 C
        GPU Shutdown Temp           : 85 C
        GPU Slowdown Temp           : N/A
    Power Readings
        Power Management            : Supported
        Power Draw                  : 30.21 W
        Power Limit                 : 300.00 W
        Default Power Limit         : 300.00 W
        Enforced Power Limit        : 300.00 W
        Min Power Limit             : 150.00 W
        Max Power Limit             : 300.00 W
    Clocks
        Graphics                    : 405 MHz
        SM                          : 405 MHz
        Memory                      : 715 MHz
        Video                       : 835 MHz
    Applications Clocks
        Graphics                    : 1328 MHz
        Memory                      : 715 MHz
    Default Applications Clocks
        Graphics                    : 1328 MHz
        Memory                      : 715 MHz
    Max Clocks
        Graphics                    : 1480 MHz
        SM                          : 1480 MHz
        Memory                      : 715 MHz
        Video                       : 1480 MHz
    Clock Policy
        Auto Boost                  : N/A
        Auto Boost Default          : N/A
    Processes                       : None

GPU 0000:84:00.0
    Product Name                    : Tesla P100-SXM2-16GB
    Product Brand                   : Tesla
    Display Mode                    : Disabled
    Display Active                  : Disabled
    Persistence Mode                : Enabled
    Accounting Mode                 : Disabled
    Accounting Mode Buffer Size     : 1920
    Driver Model
        Current                     : N/A
        Pending                     : N/A
    Serial Number                   : 0322816175136
    GPU UUID                        : GPU-ed0cadb7-82c7-f815-e5b9-316ae79d3419
    Minor Number                    : 1
    VBIOS Version                   : 86.00.1C.00.01
    MultiGPU Board                  : No
    Board ID                        : 0x8400
    GPU Part Number                 : 900-2H403-0000-000
    Inforom Version
        Image Version               : H403.0201.00.04
        OEM Object                  : 1.1
        ECC Object                  : 4.1
        Power Management Object     : N/A
    GPU Operation Mode
        Current                     : N/A
        Pending                     : N/A
    GPU Virtualization Mode
        Virtualization mode         : None
    PCI
        Bus                         : 0x84
        Device                      : 0x00
        Domain                      : 0x0000
        Device Id                   : 0x15F910DE
        Bus Id                      : 0000:84:00.0
        Sub System Id               : 0x116B10DE
        GPU Link Info
            PCIe Generation
                Max                 : 3
                Current             : 3
            Link Width
                Max                 : 16x
                Current             : 16x
        Bridge Chip
            Type                    : N/A
            Firmware                : N/A
        Replays since reset         : 0
        Tx Throughput               : 0 KB/s
        Rx Throughput               : 0 KB/s
    Fan Speed                       : N/A
    Performance State               : P0
    Clocks Throttle Reasons
        Idle                        : Active
        Applications Clocks Setting : Not Active
        SW Power Cap                : Not Active
        HW Slowdown                 : Not Active
        Sync Boost                  : Not Active
        Unknown                     : Not Active
    FB Memory Usage
        Total                       : 16276 MiB
        Used                        : 0 MiB
        Free                        : 16276 MiB
    BAR1 Memory Usage
        Total                       : 16384 MiB
        Used                        : 2 MiB
        Free                        : 16382 MiB
    Compute Mode                    : Default
    Utilization
        Gpu                         : 0 %
        Memory                      : 0 %
        Encoder                     : 0 %
        Decoder                     : 0 %
    Ecc Mode
        Current                     : Disabled
        Pending                     : Disabled
    ECC Errors
        Volatile
            Single Bit            
                Device Memory       : N/A
                Register File       : N/A
                L1 Cache            : N/A
                L2 Cache            : N/A
                Texture Memory      : N/A
                Texture Shared      : N/A
                Total               : N/A
            Double Bit            
                Device Memory       : N/A
                Register File       : N/A
                L1 Cache            : N/A
                L2 Cache            : N/A
                Texture Memory      : N/A
                Texture Shared      : N/A
                Total               : N/A
        Aggregate
            Single Bit            
                Device Memory       : N/A
                Register File       : N/A
                L1 Cache            : N/A
                L2 Cache            : N/A
                Texture Memory      : N/A
                Texture Shared      : N/A
                Total               : N/A
            Double Bit            
                Device Memory       : N/A
                Register File       : N/A
                L1 Cache            : N/A
                L2 Cache            : N/A
                Texture Memory      : N/A
                Texture Shared      : N/A
                Total               : N/A
    Retired Pages
        Single Bit ECC              : 0
        Double Bit ECC              : 0
        Pending                     : No
    Temperature
        GPU Current Temp            : 33 C
        GPU Shutdown Temp           : 85 C
        GPU Slowdown Temp           : N/A
    Power Readings
        Power Management            : Supported
        Power Draw                  : 31.24 W
        Power Limit                 : 300.00 W
        Default Power Limit         : 300.00 W
        Enforced Power Limit        : 300.00 W
        Min Power Limit             : 150.00 W
        Max Power Limit             : 300.00 W
    Clocks
        Graphics                    : 405 MHz
        SM                          : 405 MHz
        Memory                      : 715 MHz
        Video                       : 835 MHz
    Applications Clocks
        Graphics                    : 1328 MHz
        Memory                      : 715 MHz
    Default Applications Clocks
        Graphics                    : 1328 MHz
        Memory                      : 715 MHz
    Max Clocks
        Graphics                    : 1480 MHz
        SM                          : 1480 MHz
        Memory                      : 715 MHz
        Video                       : 1480 MHz
    Clock Policy
        Auto Boost                  : N/A
        Auto Boost Default          : N/A
    Processes                       : None

