# Kesch:
## cuda/75 + mvapich/22 + gcc/493

### Setup:
module purge
module load craype-haswell
module load craype-network-infiniband
module use /users/piccinal/easybuild/keschln/modules/all
module load Score-P/3.0-gmvapich2-17.02_cuda_7.5
module use /apps/common/UES/RHAT6/easybuild/modules/all
module load CMake/3.7.2

Currently Loaded Modulefiles:
craype-haswell
craype-network-infiniband
binutils/.2.25
GCC/4.9.3-binutils-2.25
cudatoolkit/7.5.18
MVAPICH2/2.2-GCC-4.9.3-binutils-2.25-cuda75
gmvapich2/17.02_cuda_7.5
zlib/.1.2.8
libunwind/.1.1
binutils/.2.26-scorep
libunwind/.1.1-scorep
Qt/.4.8.6
Cube/.4.3.3
papi/5.4.3.2
vampir/9.2.0
slurm/16.05.10-2
Score-P/3.0-gmvapich2-17.02_cuda_7.5
ncurses/.6.0
CMake/3.7.2


# ./cmakejg.sh 
#
-- The C compiler identification is GNU 4.9.3
-- The CXX compiler identification is GNU 4.9.3
-- Check for working C compiler: /apps/common/UES/sandbox/jgp/comm_overlap_bench.gitjg/cc.scorep
-- Check for working C compiler: /apps/common/UES/sandbox/jgp/comm_overlap_bench.gitjg/cc.scorep -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
-- Check for working CXX compiler: /apps/common/UES/sandbox/jgp/comm_overlap_bench.gitjg/mpicxx.scorep
-- Check for working CXX compiler: /apps/common/UES/sandbox/jgp/comm_overlap_bench.gitjg/mpicxx.scorep -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Looking for pthread.h
-- Looking for pthread.h - found
-- Looking for pthread_create
-- Looking for pthread_create - found
-- Found Threads: TRUE  
+ '[' OFF = on ']'
++ which nvcc
+ /global/opt/nvidia/cudatoolkit/7.5.18/bin/nvcc --version
+ set +x
-- Found CUDA: /global/opt/nvidia/cudatoolkit/7.5.18 (found suitable version "7.5", minimum required is "5.0") 
-- Found MPI_C: /users/piccinal/easybuild/keschln/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25-cuda75/lib/libmpi.so;/opt/slurm/16.05.10/lib64/libpmi.so  
-- Found MPI_CXX: /users/piccinal/easybuild/keschln/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25-cuda75/lib/libmpicxx.so;/users/piccinal/easybuild/keschln/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25-cuda75/lib/libmpi.so;/opt/slurm/16.05.10/lib64/libpmi.so  
-- MPI_LINK_FLAGS:  -Wl,-rpath  -Wl,/users/piccinal/easybuild/keschln/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25-cuda75/lib  -Wl,--enable-new-dtags
-- MPI_COMPILE_FLAGS: 
-- MPI_LIBRARIES: /users/piccinal/easybuild/keschln/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25-cuda75/lib/libmpicxx.so;/users/piccinal/easybuild/keschln/software/MVAPICH2/2.2-GCC-4.9.3-binutils-2.25-cuda75/lib/libmpi.so;/opt/slurm/16.05.10/lib64/libpmi.so
-- Configuring done
-- Generating done
-- Build files have been written to: /apps/common/UES/sandbox/jgp/comm_overlap_bench.gitjg/KESCH+MVAPICH22+CUDA75/CMAKE



# export MV2_USE_CUDA=1
# srun -p debug --gres=gpu:1 -N1 -n1 --ntasks-per-node=1 -t5 ./comm_overlap_benchmark -n 250
CUDA_VISIBLE_DEVICES: [0: 0] 
Configured CUDA Devices: [0: 0] 
SLURM_JOBID: 1643039
SLURM_PROCID: 0, 
SLURM_CPU_BIND: [0: quiet,mask_cpu:0x000001] 
SLURMD_NODENAME: keschcn-0001, 
MV2_USE_CUDA: 1
ELAPSED TIME (seconds) for rank=0 1.868470


# export SCOREP_WRAPPER=on
# make 
[100%] Built target comm_overlap_benchmark

export SCOREP_TOTAL_MEMORY=1G
export SCOREP_ENABLE_PROFILING=false
export SCOREP_ENABLE_TRACING=true
export SCOREP_CUDA_ENABLE=1

# srun -p debug --gres=gpu:1 -N1 -n1 --ntasks-per-node=1 -t5 ./comm_overlap_benchmark -n 250
CUDA_VISIBLE_DEVICES: [0: 0] 
Configured CUDA Devices: [0: 0] 
SLURM_JOBID: 1643186
SLURM_PROCID: 0, 
SLURM_CPU_BIND: [0: quiet,mask_cpu:0x000001] 
SLURMD_NODENAME: keschcn-0012, 
MV2_USE_CUDA: 1
ELAPSED TIME (seconds) for rank=0 2.744683

vampir scorep-20170414_1509_27108919489908686/traces.otf2 

# srun -p debug --gres=gpu:4 -N1 -n4 --ntasks-per-node=4 -t5 ./comm_overlap_benchmark -n 50
CUDA_VISIBLE_DEVICES: [0: 0,1,2,3] [1: 0,1,2,3] [2: 0,1,2,3] [3: 0,1,2,3] 
Configured CUDA Devices: [0: 0] [1: 1] [2: 2] [3: 3] 
SLURM_JOBID: 1643321
SLURM_PROCID: 0, 1, 2, 3, 
SLURM_CPU_BIND: 
[0: quiet,mask_cpu:0x000001,0x000002,0x000004,0x000008] 
[1: quiet,mask_cpu:0x000001,0x000002,0x000004,0x000008] 
[2: quiet,mask_cpu:0x000001,0x000002,0x000004,0x000008] 
[3: quiet,mask_cpu:0x000001,0x000002,0x000004,0x000008] 
SLURMD_NODENAME: keschcn-0004, keschcn-0004, keschcn-0004, keschcn-0004, 
MV2_USE_CUDA: 1
ELAPSED TIME (seconds) for rank=3 0.599270
ELAPSED TIME (seconds) for rank=1 0.600871
ELAPSED TIME (seconds) for rank=0 0.600545
ELAPSED TIME (seconds) for rank=2 0.597997


