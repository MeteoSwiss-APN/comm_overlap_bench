# --- makefile-dom:
# module load daint-gpu
# module load craype-haswell
# module load craype-network-aries
# module load Score-P/3.0-CrayGNU-2016.11-cuda-8.0.54
# 
# export SCOREP_WRAPPER=off
# make -f makefile-kesch

CUDATOOLKIT_HOME := $(CRAY_CUDATOOLKIT_DIR)
MVAPICH2_HOME := $(CRAY_MPICH2_DIR)
LIBMPI = # -lmpi -lmpicxx
CXX = ../CC2.scorep
NVCC = ../nvcc.scorep

HH := $(shell uname -n ) # |cut -c1-3 )
GNU_VERSION := $(shell gcc -v 2>&1 |grep "gcc version" |cut -d" " -f3 )
MVAPICH2_VERSION1 := $(CRAY_MPICH2_VER)
CUDATOOLKIT_VERSION := $(shell nvcc -V |grep "Cuda compilation" |cut -d" " -f6 )

EXECUTABLE := GNU$(GNU_VERSION)_MPI$(MVAPICH2_VERSION1)_CUDA$(CUDATOOLKIT_VERSION).$(HH)
all: $(EXECUTABLE)

INCFLAGS = -I$(CUDATOOLKIT_HOME)/include \
-I$(MVAPICH2_HOME)/include \
-I.

NVFLAGS  = $(INCFLAGS)
ARCH = -arch=sm_60
CFLAGS  = $(INCFLAGS)
CFLAGS += -DENABLE_MPI_TIMER -DCUDASETDEVICE # -D_NOTIMING # -DENABLE_TIMER
CFLAGS += -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11
NVFLAGS += -ccbin g++ -m64 $(ARCH) $(CFLAGS) -D__CUDACC__ -Xcompiler ,\"-g\",\"-std=c++11\"

LDFLAGS = -g -std=gnu++11 \
-Wl,--enable-new-dtags \
-L$(MVAPICH2_HOME)/lib64 \
-L$(CUDATOOLKIT_HOME)/lib64 \
$(LIBMPI) \
-lcudart -lcuda 

SRCcu = Kernel.cu HorizontalDiffusionSA.cu
SRCc  = main.cpp Repository.cpp Options.cpp MPIHelper.cpp

OBJC  := $(SRCc:.cpp=.o)
OBJCU := $(SRCcu:.cu=.o)

$(OBJC):
	$(CXX) $(CFLAGS) -c $(@:.o=.cpp) # -o $@
	@echo

$(OBJCU):
	$(NVCC) $(INCFLAGS) $(NVFLAGS) -c $(@:.o=.cu) # -o $@
	@echo

$(EXECUTABLE): $(OBJC) $(OBJCU)
	$(CXX) $(LDFLAGS) $(OBJC) $(OBJCU) -o $@

clean:
	rm -f $(OBJC) $(OBJCU) $(EXECUTABLE)


##  export CUDA_AUTOBOOST=1
##  export GCLOCK=875
##  export MPICH_RDMA_ENABLED_CUDA=1
##   piccinal@dom101:/apps/common/UES/sandbox/jgp/comm_overlap_bench.gitjg/DOM$barebones 
## srun -C gpu -N2 -n2 --ntasks-per-node=1 -t2 ./GNU5.3.0_MPI7.5.0_CUDAV8.0.61.dom101 
## CUDA_VISIBLE_DEVICES: [0: 0] [1: 0] 
## Configured CUDA Devices: [0: 0] [1: 0] 
## SLURM_JOBID: 652615
## SLURM_PROCID: 0, 1, 
## SLURM_CPU_BIND: [0: quiet,mask_cpu:0xFFFFFF] [1: quiet,mask_cpu:0xFFFFFF] 
## SLURMD_NODENAME: nid00002, nid00003, 
## MV2_USE_CUDA: 
## ELAPSED TIME (seconds) for rank=1 5.856150
## ELAPSED TIME (seconds) for rank=0 5.857021
