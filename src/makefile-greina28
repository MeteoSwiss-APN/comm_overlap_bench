# --- makefile-greina28:
# module load slurm ;salloc -p long -w greina28 
# ssh greina28 # patience...
# module use /users/piccinal/easybuild/greina/modules/all
# module load Score-P/3.0-gmvapich2-17.01_cuda_8.0.44_gdr	# built with MVAPICH2/2.2gdr-GCC-CUDA-8.0
# module rm Cube
#
#
# export SCOREP_WRAPPER=off
# make -f makefile-greina28

HH := $(shell uname -n |cut -c1-3 )
CUDATOOLKIT_HOME := /cm/shared/apps/cuda/8.0.44
MVAPICH2GDR_VERSION := /cm/shared/apps/mvapich2/gdr/2.2/cuda8.0/gcc
# BOOST_VERSION=/apps/dom/UES/jenkins/6.0.UP02/gpu/easybuild/software/Boost/1.63.0-CrayGNU-2016.11-Python-2.7.12
LIBMPI = -lmpi -lmpicxx
CXX=../mpicxx.scorep
NVCC=../nvcc.scorep

EXECUTABLE := GNU$(GNU_VERSION)-CUDA$(CUDATOOLKIT_VERSION)-Stencils.$(HH)
all: $(EXECUTABLE)

INCFLAGS = -I$(CUDATOOLKIT_HOME)/include \
-I$(MVAPICH2GDR_VERSION)/include \
-I$(BOOST_VERSION)/include \
-I.

NVFLAGS  = $(INCFLAGS)
ARCH = -arch=sm_60
CFLAGS  = $(INCFLAGS)
CFLAGS += -D_NOBOOST -DENABLE_MPI_TIMER # -D_NOTIMING # -DENABLE_TIMER
CFLAGS += -g -w -DCUDA_BACKEND -DMVAPICH2 -DENABLE_CUDA_STREAMS -DNVCC -std=c++11 
NVFLAGS += -ccbin g++ -m64 $(ARCH) $(CFLAGS) -D__CUDACC__ -Xcompiler ,\"-g\",\"-std=c++11\"

LDFLAGS = -g -std=gnu++11 \
-Wl,--enable-new-dtags \
-L$(MVAPICH2GDR_VERSION)/lib64 \
-L$(BOOST_VERSION)/lib \
-L$(CUDATOOLKIT_HOME)/lib64 \
$(LIBMPI) \
-lcudart -lcuda 

SRCcu = Kernel.cu HorizontalDiffusionSA.cu
SRCc  = main.cpp Repository.cpp Options.cpp MPIHelper.cpp

OBJC  := $(SRCc:.cpp=.o)
OBJCU := $(SRCcu:.cu=.o)

$(OBJC):
	$(CXX) $(CFLAGS) -c $(@:.o=.cpp) # -o $@
	@echo

$(OBJCU):
	$(NVCC) $(INCFLAGS) $(NVFLAGS) -c $(@:.o=.cu) # -o $@
	@echo

$(EXECUTABLE): $(OBJC) $(OBJCU)
	$(CXX) $(LDFLAGS) $(OBJC) $(OBJCU) -o $@

clean:
	rm -f $(OBJC) $(OBJCU) $(EXECUTABLE)




# export MV2_GPUDIRECT_GDRCOPY_LIB=/cm/shared/apps/gdrcopy/lib64/libgdrapi.so
# export G2G=2
# module use /users/piccinal/easybuild/greina/modules/all
# module load Score-P/3.0-gmvapich2-17.01_cuda_8.0.44_gdr

##    piccinal@greina0:~/comm_overlap_bench.gitjg/GREINA28$barebones 
##   srun --cpu_bind=cores --hint=nomultithread --mpi=pmi2 -n2 --gres=gpu:2 -w greina28 ./wrapmap-greina28 ./GNU-CUDA-Stencils.gre  
##   
##   usage: StandaloneStencilsCUDA [--ie isize] [--je jsize] [--ke ksize] \
##                                 [--sync] [--nocomm] [--nocomp] \
##                                 [--nh nhaloupdates] [-n nrepetitions] [--inorder]
##   
##   MV2_COMM_WORLD_LOCAL_RANK: 0, 1, 
##   CUDA_VISIBLE_DEVICES: [0: 0,1] [1: 0,1] 
##   Configured CUDA Devices: [0: 0] [1: 1] 
##   SLURM_JOBID: 29122
##   SLURM_PROCID: 0, 1, 
##   SLURM_CPU_BIND: [0: quiet,mask_cpu:0x0000000001,0x0000000400] [1: quiet,mask_cpu:0x0000000001,0x0000000400] 
##   SLURMD_NODENAME: greina28, greina28, 
##   
##   CONFIGURATION 
##   ====================================
##   Domain : [128,128,60]
##   Sync? : 0
##   NoComm? : 0
##   NoComp? : 0
##   Number Halo Exchanges : 2
##   Number benchmark repetitions : 1000
##   In Order halo exchanges? : 0
##   Compiled for mvapich2
##   Dimensions: [2, 1]
##   Neighbors: [0: 1,0,1,0] [1: 0,1,0,1] 
##   Warning *** The GPU and IB selected are not on the same socket.
##           *** This configuration may not deliver the best performance.
##   ELAPSED TIME (seconds) for rank=0 3.682024
##   ELAPSED TIME (seconds) for rank=1 3.682583

#
# module use /users/piccinal/easybuild/greina/modules/all
# module load Score-P/3.0-gmvapich2-17.01_cuda_8.0.44_gdr	# built with MVAPICH2/2.2gdr-GCC-CUDA-8.0
# module rm Cube
# export SCOREP_TOTAL_MEMORY=1G
# export SCOREP_ENABLE_TRACING=true
# export SCOREP_CUDA_ENABLE=1

